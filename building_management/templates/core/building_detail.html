{# path: templates/core/building_detail.html #}
{% extends "base.html" %}
{% load markdownify %}

{% block title %}{{ building.name }} · Buildings{% endblock %}

{% block content %}
  {# Back only #}
  <nav class="bm-subnav row gap">
    <a class="btn" href="{% url 'buildings_list' %}">← Back</a>
  </nav>

  <section>
    {# === Building name + actions on the same line (actions right) === #}
    <div class="row space-between" style="align-items:center; gap:1rem; flex-wrap:wrap;">
      <h2 class="mb-0">{{ building.name }}</h2>
      <div class="row gap">
        <a class="btn" href="{% url 'building_update' building.id %}">Edit</a>
        <a class="btn btn-danger" href="{% url 'building_delete' building.id %}">Delete</a>
      </div>
    </div>

    <p class="mb-1"><strong>Address:</strong> {{ building.address }}</p>
    <p class="mb-2"><strong>Owner:</strong> {% if building.owner %}{{ building.owner.username }}{% else %}—{% endif %}</p>

    <h3>Description</h3>
    <div class="bm-description mb-2">
      {% if building.description %}
        {{ building.description|markdownify }}
      {% else %}
        <em>No description.</em>
      {% endif %}
    </div>

    <hr class="section-divider" />

    {# ======================= Units ======================= #}
    <div class="row space-between" style="gap:1rem; align-items:center; flex-wrap:wrap;">
      <h3 class="mb-0">Units</h3>
      {% if can_edit %}
        <a class="btn" href="{% url 'unit_create' building.id %}">Add Unit</a>
      {% endif %}
    </div>

    {# Units filter — separate form (preserves Work Orders state) #}
    <form method="get" class="filter-grid" style="margin-top:.6rem; margin-bottom:.5rem;">
      <div class="input-group">
        <label for="id_u_q" class="sr-only">Units search</label>
        <input id="id_u_q" class="input-search" type="text" name="u_q" value="{{ u_q }}"
               placeholder="Number, floor or description" />
        <button class="btn" type="submit">Filter</button>
      </div>

      <div>
        <label for="id_u_per">Page size:</label><br/>
        <select id="id_u_per" name="u_per" onchange="this.form.submit()">
          <option value="10"  {% if u_per == 10  %}selected{% endif %}>10</option>
          <option value="20"  {% if u_per == 20  %}selected{% endif %}>20</option>
          <option value="50"  {% if u_per == 50  %}selected{% endif %}>50</option>
          <option value="100" {% if u_per == 100 %}selected{% endif %}>100</option>
        </select>
      </div>

      <div>
        {% if u_q or u_per != 10 or u_sort != 'number' %}
          <a class="btn btn-secondary" href="{% url 'building_detail' building.id %}">Reset</a>
        {% endif %}
      </div>

      {# Keep current Work Orders state when changing Units #}
      <input type="hidden" name="w_q" value="{{ w_q }}">
      <input type="hidden" name="w_status" value="{{ w_status }}">
      <input type="hidden" name="w_per" value="{{ w_per }}">
      {% if work_orders_page %}<input type="hidden" name="w_page" value="{{ work_orders_page.number }}">{% endif %}

      {# Keep current units sort (drives the table headers) #}
      <input type="hidden" name="u_sort" value="{{ u_sort }}">
    </form>

    <div class="table-wrap">
      <table class="bm-table">
        <thead>
          <tr>
            <th>
              {% with field='number' %}
                {% if u_sort == field %}
                  {% with next='-'|add:field %}
                    <a href="?u_sort={{ next }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Apartment number ▲</a>
                  {% endwith %}
                {% elif u_sort == '-'|add:field %}
                  <a href="?u_sort=number{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Apartment number ▼</a>
                {% else %}
                  <a href="?u_sort=number{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Apartment number</a>
                {% endif %}
              {% endwith %}
            </th>
            <th>
              {% with field='floor' %}
                {% if u_sort == field %}
                  {% with next='-'|add:field %}
                    <a href="?u_sort={{ next }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Floor ▲</a>
                  {% endwith %}
                {% elif u_sort == '-'|add:field %}
                  <a href="?u_sort=floor{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Floor ▼</a>
                {% else %}
                  <a href="?u_sort=floor{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Floor</a>
                {% endif %}
              {% endwith %}
            </th>
            <th>
              {% with field='occupied' %}
                {% if u_sort == field %}
                  {% with next='-'|add:field %}
                    <a href="?u_sort={{ next }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Occupied ▲</a>
                  {% endwith %}
                {% elif u_sort == '-'|add:field %}
                  <a href="?u_sort=occupied{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Occupied ▼</a>
                {% else %}
                  <a href="?u_sort=occupied{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Occupied</a>
                {% endif %}
              {% endwith %}
            </th>
            <th>Description</th>
            {% if can_edit %}<th class="text-right">Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for u in units_page %}
            <tr>
              <td><a href="{% url 'unit_update' u.id %}">{{ u.number }}</a></td>
              <td>{{ u.floor }}</td>
              <td>{{ u.occupied|yesno:"Yes,No" }}</td>
              <td>{% if u.description %}{{ u.description|truncatechars:140 }}{% else %}<span class="muted">—</span>{% endif %}</td>
              {% if can_edit %}
                <td class="text-right">
                  <a class="btn" href="{% url 'unit_update' u.id %}">Edit</a>
                  <a class="btn btn-danger" href="{% url 'unit_delete' u.id %}">Delete</a>
                </td>
              {% endif %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{% if can_edit %}5{% else %}4{% endif %}">No units.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if units_page.has_other_pages %}
      <div class="row gap mt-2" style="flex-wrap:wrap;">
        {% if units_page.has_previous %}
          <a class="btn" href="?u_page={{ units_page.previous_page_number }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}{% if u_sort %}&u_sort={{ u_sort }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">‹ Prev</a>
        {% else %}
          <span class="btn is-disabled">‹ Prev</span>
        {% endif %}
        <span class="muted">Page {{ units_page.number }} of {{ units_page.paginator.num_pages }}</span>
        {% if units_page.has_next %}
          <a class="btn" href="?u_page={{ units_page.next_page_number }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}{% if u_sort %}&u_sort={{ u_sort }}{% endif %}&u_per={{ u_per }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}">Next ›</a>
        {% else %}
          <span class="btn is-disabled">Next ›</span>
        {% endif %}
      </div>
    {% endif %}

    {# ======================= Work Orders ======================= #}
    <hr class="section-divider" />

    <div class="row space-between" style="gap:1rem; align-items:center; flex-wrap:wrap;">
      <h3 class="mb-0">Work Orders</h3>
      {% if can_edit %}
        <a class="btn" href="{% url 'work_order_create' %}?building={{ building.id }}">Add Work Order</a>
      {% endif %}
    </div>

    {# Work Orders filter — separate form (preserves Units state) #}
    <form method="get" class="filter-grid" style="margin-top:.6rem; margin-bottom:.5rem;">
      {# Search + Filter #}
      <div class="input-group">
        <label for="id_w_q" class="sr-only">Search work orders</label>
        <input
          id="id_w_q"
          class="input-search"
          type="text"
          name="w_q"
          value="{{ w_q }}"
          placeholder="Title or description"
        />
        <button class="btn" type="submit">Filter</button>
      </div>

      {# Page size first (left), Status second (right) #}
      <div>
        <label for="id_w_per">Page size:</label><br/>
        <select id="id_w_per" name="w_per" onchange="this.form.submit()">
          <option value="10"  {% if w_per == 10  %}selected{% endif %}>10</option>
          <option value="20"  {% if w_per == 20  %}selected{% endif %}>20</option>
          <option value="50"  {% if w_per == 50  %}selected{% endif %}>50</option>
          <option value="100" {% if w_per == 100 %}selected{% endif %}>100</option>
        </select>
      </div>

      <div>
        <label for="id_w_status">Status:</label><br/>
        <select id="id_w_status" name="w_status" onchange="this.form.submit()">
          <option value="" {% if not w_status %}selected{% endif %}>All</option>
          {% for v, label in w_status_choices %}
            <option value="{{ v }}" {% if w_status == v %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      {# Preserve current Units state when filtering Work Orders #}
      <input type="hidden" name="u_q"    value="{{ u_q }}">
      <input type="hidden" name="u_sort" value="{{ u_sort }}">
      <input type="hidden" name="u_per"  value="{{ u_per }}">
      {% if units_page %}<input type="hidden" name="u_page" value="{{ units_page.number }}">{% endif %}
    </form>

    <div class="table-wrap">
      <table class="bm-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Unit</th>
            <th>Status</th>
            <th>Created</th>
            {% if can_edit %}<th class="text-right">Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for w in work_orders_page %}
            <tr>
              <td><a href="{% url 'work_order_update' w.id %}">{{ w.title }}</a></td>
              <td>{% if w.unit_id %}#{{ w.unit.number }}{% else %}—{% endif %}</td>
              <td>{{ w.get_status_display }}</td>
              <td>{{ w.created_at|date:"Y-m-d H:i" }}</td>
              {% if can_edit %}
                <td class="text-right">
                  <a class="btn" href="{% url 'work_order_update' w.id %}">Edit</a>
                  <a class="btn btn-danger" href="{% url 'work_order_delete' w.id %}?building={{ building.id }}">Delete</a>
                </td>
              {% endif %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{% if can_edit %}5{% else %}4{% endif %}">No work orders for this building.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if work_orders_page.has_other_pages %}
      <div class="row gap mt-2" style="flex-wrap:wrap;">
        {% if work_orders_page.has_previous %}
          <a class="btn" href="?w_page={{ work_orders_page.previous_page_number }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}{% if u_sort %}&u_sort={{ u_sort }}{% endif %}&u_per={{ u_per }}">‹ Prev</a>
        {% else %}
          <span class="btn is-disabled">‹ Prev</span>
        {% endif %}
        <span class="muted">Page {{ work_orders_page.number }} of {{ work_orders_page.paginator.num_pages }}</span>
        {% if work_orders_page.has_next %}
          <a class="btn" href="?w_page={{ work_orders_page.next_page_number }}{% if w_q %}&w_q={{ w_q|urlencode }}{% endif %}{% if w_status %}&w_status={{ w_status }}{% endif %}&w_per={{ w_per }}{% if u_q %}&u_q={{ u_q|urlencode }}{% endif %}{% if u_sort %}&u_sort={{ u_sort }}{% endif %}&u_per={{ u_per }}">Next ›</a>
        {% else %}
          <span class="btn is-disabled">Next ›</span>
        {% endif %}
      </div>
    {% endif %}
  </section>
{% endblock %}
