{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Buildings" %}{% endblock %}

{% block content %}
  <section class="space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-semibold text-brand-foreground dark:text-white">{% trans "Buildings" %}</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "Browse and manage your properties." %}</p>
        <p class="text-sm font-medium text-slate-600 dark:text-slate-300">
          {% blocktrans with count=buildings_total %}Total buildings: {{ count }}{% endblocktrans %}
        </p>
      </div>
      {% if can_manage_buildings %}
        <a class="btn self-start md:self-center" href="{% url 'core:building_create' %}">{% trans "Add new building" %}</a>
      {% endif %}
    </div>

    <div>
      <form method="get" class="space-y-5 rounded-3xl border border-emerald-100/80 bg-white/90 p-6 shadow-card backdrop-blur dark:border-emerald-400/40 dark:bg-slate-900">
        {% url 'core:buildings_list' as buildings_reset_url %}
        {% with placeholder=_('Search by name, address, owner') %}
          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-600 dark:text-slate-300" for="id_q">{% trans "Search buildings" %}</label>
            <input id="id_q" class="input rounded-2xl border border-emerald-100/80 focus:border-emerald-400 focus:ring-emerald-200/70 dark:border-emerald-500/40" type="text" name="q" value="{{ q }}" placeholder="{{ placeholder }}" autocomplete="off" />
          </div>
        {% endwith %}

        <div class="space-y-2">
          <label for="id_per" class="text-sm font-medium text-slate-600 dark:text-slate-300">{% trans "Page size" %}</label>
          <select id="id_per" name="per" onchange="this.form.submit()" class="input rounded-2xl border border-emerald-100/80 focus:border-emerald-400 focus:ring-emerald-200/70 dark:border-emerald-500/40">
            <option value="25"  {% if per == 25  %}selected{% endif %}>25</option>
            <option value="50"  {% if per == 50  %}selected{% endif %}>50</option>
            <option value="100" {% if per == 100 %}selected{% endif %}>100</option>
            <option value="200" {% if per == 200 %}selected{% endif %}>200</option>
          </select>
        </div>

        <div class="flex justify-end gap-2">
          <button class="btn" type="submit">{% trans "Filter" %}</button>
          {% if q or sort != 'name' or per != 25 %}
            <a class="btn btn-secondary" href="{{ buildings_reset_url }}">{% trans "Reset" %}</a>
          {% endif %}
        </div>
      </form>
    </div>

    <div class="grid gap-4 md:hidden">
      {% for b in buildings %}
        <article class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-card dark:border-slate-700 dark:bg-slate-900">
          <div class="flex flex-wrap items-start justify-between gap-2">
            <div>
              <a href="{% url 'core:building_detail' b.id %}" class="text-lg font-semibold text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200 break-words hyphens-auto">{{ b.name }}</a>
              <p class="text-sm text-slate-500 dark:text-slate-400">{{ b.get_role_display }}</p>
            </div>
            {% if show_owner_column %}
              <span class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300">
                {% trans "Owner" %}:
                {% with owner=b.owner %}
                  {% if owner %}
                    {{ owner.get_full_name|default:owner.username }}
                  {% else %}
                    &mdash;
                  {% endif %}
                {% endwith %}
              </span>
            {% endif %}
          </div>

          {% if b.address %}
            <p class="text-sm text-slate-600 dark:text-slate-300">{{ b.address }}</p>
          {% endif %}

          <dl class="grid grid-cols-2 gap-3 text-sm text-slate-600 dark:text-slate-300">
            <div>
              <dt class="font-semibold text-slate-500 dark:text-slate-400">{% trans "Units" %}</dt>
              <dd>{{ b.units_count }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-500 dark:text-slate-400">{% trans "Work orders" %}</dt>
              <dd>{{ b.work_orders_count }}</dd>
            </div>
          </dl>
        </article>
      {% empty %}
        <article class="rounded-2xl border border-dashed border-slate-200 bg-white p-4 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300">{% trans "No buildings found." %}</article>
      {% endfor %}
    </div>

    <div class="hidden overflow-x-auto md:block">
      <table class="min-w-full divide-y divide-slate-200 rounded-2xl border border-slate-200 bg-white text-sm shadow-sm dark:divide-slate-700 dark:border-slate-700 dark:bg-slate-900">
        <thead class="bg-slate-50 dark:bg-slate-800">
          <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
            <th class="px-4 py-3">
              {% with field='name' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-name&per={{ per }}">{% trans "Name" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=name&per={{ per }}">{% trans "Name" %} ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=name&per={{ per }}">{% trans "Name" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            {% if show_owner_column %}
              <th class="px-4 py-3">
                {% with field='owner' %}
                  {% if sort == field %}
                    <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-owner&per={{ per }}">{% trans "Owner" %} ▲</a>
                  {% elif sort == '-'|add:field %}
                    <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=owner&per={{ per }}">{% trans "Owner" %} ▼</a>
                  {% else %}
                    <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=owner&per={{ per }}">{% trans "Owner" %}</a>
                  {% endif %}
                {% endwith %}
              </th>
            {% endif %}
            <th class="px-4 py-3">
              {% with field='role' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-role&per={{ per }}">{% trans "Role" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=role&per={{ per }}">{% trans "Role" %} ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=role&per={{ per }}">{% trans "Role" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3">
              {% with field='address' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-address&per={{ per }}">{% trans "Address" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=address&per={{ per }}">{% trans "Address" %} ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=address&per={{ per }}">{% trans "Address" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3 text-right">
              {% with field='units_count' %}
                {% if sort == field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-units_count&per={{ per }}">{% trans "Units" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=units_count&per={{ per }}">{% trans "Units" %} ▼</a>
                {% else %}
                  <a class="flex justify-end gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=units_count&per={{ per }}">{% trans "Units" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3 text-right">
              {% with field='work_orders_count' %}
                {% if sort == field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-work_orders_count&per={{ per }}">{% trans "Work Orders" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=work_orders_count&per={{ per }}">{% trans "Work Orders" %} ▼</a>
                {% else %}
                  <a class="flex justify-end gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=work_orders_count&per={{ per }}">{% trans "Work Orders" %}</a>
                {% endif %}
              {% endwith %}
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
          {% for b in buildings %}
            <tr class="text-sm text-slate-700 dark:text-slate-200">
              <td class="px-4 py-3 font-medium">
                <a href="{% url 'core:building_detail' b.id %}" class="text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200 break-words hyphens-auto">{{ b.name }}</a>
              </td>
              {% if show_owner_column %}
                <td class="px-4 py-3">
                  {% with owner=b.owner %}
                    {% if owner %}
                      {{ owner.get_full_name|default:owner.username }}
                    {% else %}
                      &mdash;
                    {% endif %}
                  {% endwith %}
                </td>
              {% endif %}
              <td class="px-4 py-3">{{ b.get_role_display }}</td>
              <td class="px-4 py-3">{{ b.address }}</td>
              <td class="px-4 py-3 text-right">{{ b.units_count }}</td>
              <td class="px-4 py-3 text-right">{{ b.work_orders_count }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="{{ show_owner_column|yesno:'6,5' }}" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-300">
                {% trans "No buildings found." %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      {% include "core/includes/pagination.html" with page_obj=page_obj paginator=paginator query_string=pagination_query %}
    {% endif %}
  </section>
{% endblock %}
