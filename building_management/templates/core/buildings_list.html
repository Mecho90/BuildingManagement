{% extends "base.html" %}

{% block title %}Buildings{% endblock %}

{% block content %}
  <section class="space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-semibold text-brand-foreground dark:text-white">Buildings</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">Browse and manage your properties.</p>
      </div>
      <a class="btn self-start md:self-center" href="{% url 'building_create' %}">Add new building</a>
    </div>

    <div class="md:sticky md:top-4 md:z-10">
      <form method="get" class="grid gap-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm backdrop-blur dark:border-slate-700 dark:bg-slate-900 md:grid-cols-[minmax(0,1fr)_auto_auto] md:items-end">
        <div class="flex flex-col gap-2 md:flex-row md:items-center">
          <label for="id_q" class="sr-only">Search</label>
          <input id="id_q" class="input" type="text" name="q" value="{{ q }}" placeholder="Search by name, address, owner"/>
          <button class="btn md:ml-2 md:mt-0" type="submit">Filter</button>
        </div>

        <div class="flex items-center gap-2 md:justify-end">
          <label for="id_per" class="text-sm font-medium text-slate-600 dark:text-slate-300">Page size</label>
          <select id="id_per" name="per" onchange="this.form.submit()" class="input w-28">
            <option value="10"  {% if per == 10  %}selected{% endif %}>10</option>
            <option value="20"  {% if per == 20  %}selected{% endif %}>20</option>
            <option value="50"  {% if per == 50  %}selected{% endif %}>50</option>
            <option value="100" {% if per == 100 %}selected{% endif %}>100</option>
          </select>
        </div>

        {% if q or sort != 'name' or per != 10 %}
          <div class="flex justify-end">
            <a class="btn btn-secondary" href="{% url 'buildings_list' %}">Reset</a>
          </div>
        {% endif %}
      </form>
    </div>

    <div class="grid gap-4 md:hidden">
      {% for b in buildings %}
        <article class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-card dark:border-slate-700 dark:bg-slate-900">
          <div class="flex flex-wrap items-start justify-between gap-2">
            <div>
              <a href="{% url 'building_detail' b.id %}" class="text-lg font-semibold text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200 break-words hyphens-auto">{{ b.name }}</a>
              <p class="text-sm text-slate-500 dark:text-slate-400">{{ b.get_role_display }}</p>
            </div>
            {% if show_owner_column %}
              <span class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300">
                Owner: {{ b.owner }}
              </span>
            {% endif %}
          </div>

          {% if b.address %}
            <p class="text-sm text-slate-600 dark:text-slate-300">{{ b.address }}</p>
          {% endif %}

          <dl class="grid grid-cols-2 gap-3 text-sm text-slate-600 dark:text-slate-300">
            <div>
              <dt class="font-semibold text-slate-500 dark:text-slate-400">Units</dt>
              <dd>{{ b.units_count }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-500 dark:text-slate-400">Work orders</dt>
              <dd>{{ b.work_orders_count }}</dd>
            </div>
          </dl>
        </article>
      {% empty %}
        <article class="rounded-2xl border border-dashed border-slate-200 bg-white p-4 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300">No buildings found.</article>
      {% endfor %}
    </div>

    <div class="hidden overflow-x-auto md:block">
      <table class="min-w-full divide-y divide-slate-200 rounded-2xl border border-slate-200 bg-white text-sm shadow-sm dark:divide-slate-700 dark:border-slate-700 dark:bg-slate-900">
        <thead class="bg-slate-50 dark:bg-slate-800">
          <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
            <th class="px-4 py-3">
              {% with field='name' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-name&per={{ per }}">Name ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=name&per={{ per }}">Name ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=name&per={{ per }}">Name</a>
                {% endif %}
              {% endwith %}
            </th>
            {% if show_owner_column %}
              <th class="px-4 py-3">
                {% with field='owner' %}
                  {% if sort == field %}
                    <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-owner&per={{ per }}">Owner ▲</a>
                  {% elif sort == '-'|add:field %}
                    <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=owner&per={{ per }}">Owner ▼</a>
                  {% else %}
                    <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=owner&per={{ per }}">Owner</a>
                  {% endif %}
                {% endwith %}
              </th>
            {% endif %}
            <th class="px-4 py-3">
              {% with field='role' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-role&per={{ per }}">Role ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=role&per={{ per }}">Role ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=role&per={{ per }}">Role</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3">
              {% with field='address' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-address&per={{ per }}">Address ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=address&per={{ per }}">Address ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=address&per={{ per }}">Address</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3 text-right">
              {% with field='units_count' %}
                {% if sort == field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-units_count&per={{ per }}">Units ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=units_count&per={{ per }}">Units ▼</a>
                {% else %}
                  <a class="flex justify-end gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=units_count&per={{ per }}">Units</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3 text-right">
              {% with field='work_orders_count' %}
                {% if sort == field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-work_orders_count&per={{ per }}">Work Orders ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=work_orders_count&per={{ per }}">Work Orders ▼</a>
                {% else %}
                  <a class="flex justify-end gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=work_orders_count&per={{ per }}">Work Orders</a>
                {% endif %}
              {% endwith %}
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
          {% for b in buildings %}
            <tr class="text-sm text-slate-700 dark:text-slate-200">
              <td class="px-4 py-3 font-medium">
                <a href="{% url 'building_detail' b.id %}" class="text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200 break-words hyphens-auto">{{ b.name }}</a>
              </td>
              {% if show_owner_column %}
                <td class="px-4 py-3">{{ b.owner }}</td>
              {% endif %}
              <td class="px-4 py-3">{{ b.get_role_display }}</td>
              <td class="px-4 py-3">{{ b.address }}</td>
              <td class="px-4 py-3 text-right">{{ b.units_count }}</td>
              <td class="px-4 py-3 text-right">{{ b.work_orders_count }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="{{ show_owner_column|yesno:'6,5' }}" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-300">
                No buildings found.
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      <nav class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-2">
          {% if page_obj.has_previous %}
            <a class="btn btn-secondary" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&sort={{ sort }}&per={{ per }}">‹ Prev</a>
          {% else %}
            <span class="btn is-disabled">‹ Prev</span>
          {% endif %}
          {% if page_obj.has_next %}
            <a class="btn btn-secondary" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&sort={{ sort }}&per={{ per }}">Next ›</a>
          {% else %}
            <span class="btn is-disabled">Next ›</span>
          {% endif %}
        </div>
        <span class="text-sm text-slate-500 dark:text-slate-300">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>
      </nav>
    {% endif %}

    <section class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-lg font-semibold text-brand-foreground dark:text-white">Notifications</h2>
        {% if notifications %}
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">{{ notifications|length }} alerts</span>
        {% endif %}
      </div>
      {% if notifications %}
        <ul class="mt-3 space-y-3">
          {% for note in notifications %}
            <li class="alert alert--{{ note.level }}">{{ note.message }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">No notifications right now.</p>
      {% endif %}
    </section>
  </section>
{% endblock %}
