{% extends "base.html" %}

{% block title %}Buildings{% endblock %}

{% block content %}
  <h1>Buildings</h1>

  <form method="get" class="row" style="gap:1rem; flex-wrap:wrap; align-items:flex-end; margin:.5rem 0 1rem;">
    <div class="input-group joined" style="flex:1; min-width:320px; max-width:640px;">
      <label for="id_q" class="sr-only">Search</label>
      <input id="id_q" class="input-search" type="text" name="q" value="{{ q }}" placeholder="Name, address, owner"/>
      <button class="btn" type="submit">Filter</button>
    </div>

    <div class="row" style="gap:.5rem; align-items:center;">
      <label for="id_per" style="margin:0;">Page size:</label>
      <select id="id_per" name="per" onchange="this.form.submit()">
        <option value="10"  {% if per == 10  %}selected{% endif %}>10</option>
        <option value="20"  {% if per == 20  %}selected{% endif %}>20</option>
        <option value="50"  {% if per == 50  %}selected{% endif %}>50</option>
        <option value="100" {% if per == 100 %}selected{% endif %}>100</option>
      </select>
    </div>

    {% if q or sort != 'name' or per != 10 %}
      <div><a class="btn btn-secondary" href="{% url 'buildings_list' %}">Reset</a></div>
    {% endif %}

    <a class="btn" href="{% url 'building_create' %}">Add new building</a>
  </form>

  <div class="table-wrap">
    <table class="bm-table">
      <thead>
        <tr>
          <th>
            {% with field='name' %}
              {% if sort == field %}
                <a href="?q={{ q|urlencode }}&sort=-name&per={{ per }}">Name ▲</a>
              {% elif sort == '-'|add:field %}
                <a href="?q={{ q|urlencode }}&sort=name&per={{ per }}">Name ▼</a>
              {% else %}
                <a href="?q={{ q|urlencode }}&sort=name&per={{ per }}">Name</a>
              {% endif %}
            {% endwith %}
          </th>
          <th>
            {% with field='address' %}
              {% if sort == field %}
                <a href="?q={{ q|urlencode }}&sort=-address&per={{ per }}">Address ▲</a>
              {% elif sort == '-'|add:field %}
                <a href="?q={{ q|urlencode }}&sort=address&per={{ per }}">Address ▼</a>
              {% else %}
                <a href="?q={{ q|urlencode }}&sort=address&per={{ per }}">Address</a>
              {% endif %}
            {% endwith %}
          </th>
          <th class="text-right">
            {% with field='units_total' %}
              {% if sort == field %}
                <a href="?q={{ q|urlencode }}&sort=-units_total&per={{ per }}">Units ▲</a>
              {% elif sort == '-'|add:field %}
                <a href="?q={{ q|urlencode }}&sort=units_total&per={{ per }}">Units ▼</a>
              {% else %}
                <a href="?q={{ q|urlencode }}&sort=units_total&per={{ per }}">Units</a>
              {% endif %}
            {% endwith %}
          </th>
          <th class="text-right">
            {% with field='work_orders_open' %}
              {% if sort == field %}
                <a href="?q={{ q|urlencode }}&sort=-work_orders_open&per={{ per }}">Work Orders (Open) ▲</a>
              {% elif sort == '-'|add:field %}
                <a href="?q={{ q|urlencode }}&sort=work_orders_open&per={{ per }}">Work Orders (Open) ▼</a>
              {% else %}
                <a href="?q={{ q|urlencode }}&sort=work_orders_open&per={{ per }}">Work Orders (Open)</a>
              {% endif %}
            {% endwith %}
          </th>
        </tr>
      </thead>
      <tbody>
        {% for b in buildings %}
          <tr>
            <td><a href="{% url 'building_detail' b.id %}">{{ b.name }}</a></td>
            <td>{{ b.address }}</td>
            <td class="text-right">{{ b.units_total|default:0 }}</td>
            <td class="text-right">{{ b.work_orders_open|default:0 }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No buildings found.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if is_paginated %}
    <div class="row gap mt-2" style="flex-wrap:wrap;">
      {% if page_obj.has_previous %}
        <a class="btn" href="?page={{ page_obj.previous_page_number }}&q={{ q|urlencode }}&sort={{ sort }}&per={{ per }}">‹ Prev</a>
      {% else %}
        <span class="btn is-disabled">‹ Prev</span>
      {% endif %}

      <span class="muted">Page {{ page_obj.number }} of {{ paginator.num_pages }}</span>

      {% if page_obj.has_next %}
        <a class="btn" href="?page={{ page_obj.next_page_number }}&q={{ q|urlencode }}&sort={{ sort }}&per={{ per }}">Next ›</a>
      {% else %}
        <span class="btn is-disabled">Next ›</span>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
