{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Buildings" %}{% endblock %}

{% block content %}
  <section class="space-y-8">
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl font-semibold text-brand-foreground dark:text-white">{% trans "Buildings" %}</h1>
        <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "Browse and manage your properties." %}</p>
      </div>
      <a class="btn self-start md:self-center" href="{% url 'building_create' %}">{% trans "Add new building" %}</a>
    </div>

    <div class="md:sticky md:top-4 md:z-10">
      <form method="get" class="grid gap-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm backdrop-blur dark:border-slate-700 dark:bg-slate-900 md:grid-cols-[minmax(0,1fr)_auto_auto] md:items-end">
        {% url 'buildings_list' as buildings_reset_url %}
        {% with placeholder=_('Search by name, address, owner') %}
          <div class="flex flex-col gap-2 md:flex-row md:items-center">
            <label class="sr-only" for="id_q">{% trans "Search buildings" %}</label>
            <input id="id_q" class="input flex-1" type="text" name="q" value="{{ q }}" placeholder="{{ placeholder }}" autocomplete="off" />
            <button class="btn md:ml-2 md:mt-0" type="submit">{% trans "Filter" %}</button>
            {% if q or sort != 'name' or per != 10 %}
              <a class="btn btn-secondary md:mt-0" href="{{ buildings_reset_url }}">{% trans "Reset" %}</a>
            {% endif %}
          </div>
        {% endwith %}

        <div class="flex items-center gap-2 md:justify-end">
          <label for="id_per" class="text-sm font-medium text-slate-600 dark:text-slate-300">{% trans "Page size" %}</label>
          <select id="id_per" name="per" onchange="this.form.submit()" class="input w-28">
            <option value="10"  {% if per == 10  %}selected{% endif %}>10</option>
            <option value="20"  {% if per == 20  %}selected{% endif %}>20</option>
            <option value="50"  {% if per == 50  %}selected{% endif %}>50</option>
            <option value="100" {% if per == 100 %}selected{% endif %}>100</option>
          </select>
        </div>

      </form>
    </div>

    <div class="grid gap-4 md:hidden">
      {% for b in buildings %}
        <article class="space-y-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-card dark:border-slate-700 dark:bg-slate-900">
          <div class="flex flex-wrap items-start justify-between gap-2">
            <div>
              <a href="{% url 'building_detail' b.id %}" class="text-lg font-semibold text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200 break-words hyphens-auto">{{ b.name }}</a>
              <p class="text-sm text-slate-500 dark:text-slate-400">{{ b.get_role_display }}</p>
            </div>
            {% if show_owner_column %}
              <span class="rounded-full border border-slate-200 bg-slate-50 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-300">
                {% trans "Owner" %}:
                {% with owner=b.owner %}
                  {% if owner %}
                    {{ owner.get_full_name|default:owner.username }}
                  {% else %}
                    &mdash;
                  {% endif %}
                {% endwith %}
              </span>
            {% endif %}
          </div>

          {% if b.address %}
            <p class="text-sm text-slate-600 dark:text-slate-300">{{ b.address }}</p>
          {% endif %}

          <dl class="grid grid-cols-2 gap-3 text-sm text-slate-600 dark:text-slate-300">
            <div>
              <dt class="font-semibold text-slate-500 dark:text-slate-400">{% trans "Units" %}</dt>
              <dd>{{ b.units_count }}</dd>
            </div>
            <div>
              <dt class="font-semibold text-slate-500 dark:text-slate-400">{% trans "Work orders" %}</dt>
              <dd>{{ b.work_orders_count }}</dd>
            </div>
          </dl>
        </article>
      {% empty %}
        <article class="rounded-2xl border border-dashed border-slate-200 bg-white p-4 text-center text-sm text-slate-500 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-300">{% trans "No buildings found." %}</article>
      {% endfor %}
    </div>

    <div class="hidden overflow-x-auto md:block">
      <table class="min-w-full divide-y divide-slate-200 rounded-2xl border border-slate-200 bg-white text-sm shadow-sm dark:divide-slate-700 dark:border-slate-700 dark:bg-slate-900">
        <thead class="bg-slate-50 dark:bg-slate-800">
          <tr class="text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">
            <th class="px-4 py-3">
              {% with field='name' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-name&per={{ per }}">{% trans "Name" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=name&per={{ per }}">{% trans "Name" %} ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=name&per={{ per }}">{% trans "Name" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            {% if show_owner_column %}
              <th class="px-4 py-3">
                {% with field='owner' %}
                  {% if sort == field %}
                    <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-owner&per={{ per }}">{% trans "Owner" %} ▲</a>
                  {% elif sort == '-'|add:field %}
                    <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=owner&per={{ per }}">{% trans "Owner" %} ▼</a>
                  {% else %}
                    <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=owner&per={{ per }}">{% trans "Owner" %}</a>
                  {% endif %}
                {% endwith %}
              </th>
            {% endif %}
            <th class="px-4 py-3">
              {% with field='role' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-role&per={{ per }}">{% trans "Role" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=role&per={{ per }}">{% trans "Role" %} ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=role&per={{ per }}">{% trans "Role" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3">
              {% with field='address' %}
                {% if sort == field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-address&per={{ per }}">{% trans "Address" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex items-center gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=address&per={{ per }}">{% trans "Address" %} ▼</a>
                {% else %}
                  <a class="flex items-center gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=address&per={{ per }}">{% trans "Address" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3 text-right">
              {% with field='units_count' %}
                {% if sort == field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-units_count&per={{ per }}">{% trans "Units" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=units_count&per={{ per }}">{% trans "Units" %} ▼</a>
                {% else %}
                  <a class="flex justify-end gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=units_count&per={{ per }}">{% trans "Units" %}</a>
                {% endif %}
              {% endwith %}
            </th>
            <th class="px-4 py-3 text-right">
              {% with field='work_orders_count' %}
                {% if sort == field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=-work_orders_count&per={{ per }}">{% trans "Work Orders" %} ▲</a>
                {% elif sort == '-'|add:field %}
                  <a class="flex justify-end gap-1 text-sky-600" href="?q={{ q|urlencode }}&sort=work_orders_count&per={{ per }}">{% trans "Work Orders" %} ▼</a>
                {% else %}
                  <a class="flex justify-end gap-1 text-slate-600 hover:text-sky-600 dark:text-slate-200" href="?q={{ q|urlencode }}&sort=work_orders_count&per={{ per }}">{% trans "Work Orders" %}</a>
                {% endif %}
              {% endwith %}
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
          {% for b in buildings %}
            <tr class="text-sm text-slate-700 dark:text-slate-200">
              <td class="px-4 py-3 font-medium">
                <a href="{% url 'building_detail' b.id %}" class="text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200 break-words hyphens-auto">{{ b.name }}</a>
              </td>
              {% if show_owner_column %}
                <td class="px-4 py-3">
                  {% with owner=b.owner %}
                    {% if owner %}
                      {{ owner.get_full_name|default:owner.username }}
                    {% else %}
                      &mdash;
                    {% endif %}
                  {% endwith %}
                </td>
              {% endif %}
              <td class="px-4 py-3">{{ b.get_role_display }}</td>
              <td class="px-4 py-3">{{ b.address }}</td>
              <td class="px-4 py-3 text-right">{{ b.units_count }}</td>
              <td class="px-4 py-3 text-right">{{ b.work_orders_count }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="{{ show_owner_column|yesno:'6,5' }}" class="px-4 py-6 text-center text-sm text-slate-500 dark:text-slate-300">
                {% trans "No buildings found." %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if is_paginated %}
      {% include "core/includes/pagination.html" with page_obj=page_obj paginator=paginator query_string=pagination_query %}
    {% endif %}

    <section class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-lg font-semibold text-brand-foreground dark:text-white">{% trans "Notifications" %}</h2>
        {% if notifications_page and notifications_page.paginator.count %}
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
            {% blocktrans count total=notifications_page.paginator.count %}{{ total }} alert{% plural %}{{ total }} alerts{% endblocktrans %}
          </span>
        {% endif %}
      </div>
      {% if notifications_page and notifications_page.object_list %}
        <ul class="mt-3 space-y-3">
          {% for note in notifications_page %}
            <li class="rounded-2xl border p-4 text-sm shadow-sm transition sm:flex sm:items-start sm:justify-between{% if note.level == 'danger' %} border-rose-200 bg-rose-50 text-rose-900 dark:border-rose-800 dark:bg-rose-900/40 dark:text-rose-100{% elif note.level == 'warning' %} border-amber-200 bg-amber-50 text-amber-900 dark:border-amber-700 dark:bg-amber-900/40 dark:text-amber-100{% else %} border-slate-200 bg-white text-slate-700 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200{% endif %}" data-notification-key="{{ note.id }}" data-is-new="{{ note.is_new|yesno:'true,false' }}">
              <div class="flex flex-col gap-2 sm:max-w-3xl">
                {% if note.level %}
                  <div class="flex items-center gap-2">
                    {% if note.level == 'danger' %}
                      <span class="rounded-full bg-rose-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-rose-700 dark:bg-rose-900/60 dark:text-rose-200">{{ note.level_label|default:note.level }}</span>
                    {% elif note.level == 'warning' %}
                      <span class="rounded-full bg-amber-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-amber-700 dark:bg-amber-900/60 dark:text-amber-200">{{ note.level_label|default:note.level }}</span>
                    {% else %}
                      <span class="rounded-full bg-emerald-100 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-900/60 dark:text-emerald-200">{{ note.level_label|default:note.level }}</span>
                    {% endif %}
                  </div>
                {% endif %}
                <span class="leading-snug">{{ note.message }}</span>
              </div>
              {% if note.dismissible %}
                <div class="mt-3 flex sm:mt-0 sm:justify-end">
                  <form method="post"
                        action="{% url 'notification_snooze' note.id %}"
                        hx-post="{% url 'notification_snooze' note.id %}"
                        hx-target="closest li"
                        hx-swap="delete"
                        class="inline-flex">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-secondary btn-sm">{% trans "Read" %}</button>
                  </form>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        {% if notifications_page %}
          {% include "core/includes/pagination.html" with page_obj=notifications_page paginator=notifications_page.paginator query_string=note_page_query page_param="note_page" %}
        {% endif %}
      {% else %}
        <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">{% trans "No notifications right now." %}</p>
      {% endif %}
    </section>
  </section>
{% endblock %}
