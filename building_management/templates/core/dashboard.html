{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %}{% endblock %}

{% block content %}
<section class="space-y-8">
    <header class="rounded-2xl border border-slate-200 bg-white p-6 shadow-card dark:border-slate-700 dark:bg-slate-900">
      <h1 class="page-heading text-2xl font-semibold text-brand-foreground dark:text-white">{% trans "Dashboard" %}</h1>
      <p class="text-sm font-medium text-slate-600 dark:text-slate-300">
        {% blocktrans with load=assignment_load %}You currently have {{ load }} open assignments across your buildings.{% endblocktrans %}
      </p>
    {% if dashboard_label %}
      <p class="text-sm text-slate-500 dark:text-slate-400">
        {{ dashboard_label }}
      </p>
    {% endif %}
    </header>

  {% with card_base="rounded-lg border border-slate-200 bg-white p-3 text-[13px] shadow-sm transition dark:border-slate-700 dark:bg-slate-800 dark:text-slate-100" section_shell="rounded-xl border border-slate-200 bg-white/90 p-4 shadow-card dark:border-slate-700 dark:bg-slate-900/70" %}
    <section class="space-y-4">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-xl font-semibold text-brand-foreground dark:text-white">{% trans "Deadline alerts" %}</h2>
        {% if deadline_alert_page and deadline_alert_page.paginator.count %}
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
            {% blocktrans count total=deadline_alert_page.paginator.count %}{{ total }} items{% plural %}{{ total }} items{% endblocktrans %}
          </span>
        {% endif %}
      </div>
      <div class="{{ section_shell }}">
        {% if deadline_alert_cards %}
          <div class="grid gap-3 md:grid-cols-2">
            {% for alert in deadline_alert_cards %}
              <article class="{{ card_base }}">
                <div class="flex items-start justify-between gap-3">
                  <div class="space-y-1">
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">{{ alert.building }}</p>
                    <h3 class="text-base font-semibold text-slate-900 dark:text-white truncate">{{ alert.title }}</h3>
                  </div>
                  <span class="priority-badge {% if alert.priority == 'HIGH' %}priority-badge--high{% elif alert.priority == 'MEDIUM' %}priority-badge--medium{% else %}priority-badge--low{% endif %}">
                    {{ alert.priority_label }}
                  </span>
                </div>
                <div class="mt-2 flex flex-wrap items-center gap-3 text-[12px] text-slate-600 dark:text-slate-300">
                  <span class="font-semibold {% if alert.is_overdue %}text-rose-600 dark:text-rose-300{% else %}text-amber-600 dark:text-amber-300{% endif %}">{{ alert.timing_text }}</span>
                  <span>{% trans "Deadline" %}: {{ alert.deadline_display }}</span>
                  <span>{% trans "Status" %}: {{ alert.status_label }}</span>
                </div>
                <div class="mt-3 flex gap-2">
                  <a class="btn btn-xs" href="{% url 'core:work_order_detail' alert.id %}">{% trans "View" %}</a>
                  <a class="btn btn-secondary btn-xs" href="{% url 'core:work_order_update' alert.id %}">{% trans "Update" %}</a>
                </div>
              </article>
            {% endfor %}
          </div>
          {% if deadline_alert_page %}
            <div class="mt-4">
              {% include "core/includes/pagination.html" with page_obj=deadline_alert_page paginator=deadline_alert_page.paginator query_string=deadline_page_query page_param="deadline_page" show_single_page=True %}
            </div>
          {% endif %}
        {% else %}
          <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "No work orders are approaching or past their deadlines." %}</p>
        {% endif %}
      </div>
    </section>

    {% if technician_cards %}
      <section class="space-y-4">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-semibold text-brand-foreground dark:text-white">{{ technician_section_title }}</h2>
          {% if technician_cards_page and technician_cards_page.paginator.count %}
            <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
              {% blocktrans count total=technician_cards_page.paginator.count %}{{ total }} jobs{% plural %}{{ total }} jobs{% endblocktrans %}
            </span>
          {% endif %}
        </div>
        <div class="{{ section_shell }}">
          {% if technician_cards %}
            <div class="grid gap-3 md:grid-cols-2">
              {% for job in technician_cards %}
                <article class="{{ card_base }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="space-y-1">
                      <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-300">{{ job.building }}</p>
                      <h3 class="text-base font-semibold text-slate-900 dark:text-white truncate">{{ job.title }}</h3>
                      {% if job.description %}
                        <p class="text-xs text-slate-600 dark:text-slate-300 line-clamp-2">{{ job.description }}</p>
                      {% endif %}
                    </div>
                    <span class="priority-badge {% if job.priority == 'HIGH' %}priority-badge--high{% elif job.priority == 'MEDIUM' %}priority-badge--medium{% else %}priority-badge--low{% endif %}">
                      {{ job.priority_label }}
                    </span>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-3 text-[12px] text-slate-600 dark:text-slate-300">
                    <span>{% trans "Deadline" %}: {{ job.deadline }}</span>
                    <span>{% trans "Status" %}: {{ job.status_label }}</span>
                  </div>
                  <div class="mt-3 flex gap-2">
                    <a class="btn btn-xs" href="{% url 'core:work_order_detail' job.id %}">{% trans "View" %}</a>
                    {% if job.can_update %}
                      <a class="btn btn-secondary btn-xs" href="{% url 'core:work_order_update' job.id %}">{% trans "Update" %}</a>
                    {% endif %}
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "No work orders assigned for today." %}</p>
          {% endif %}
          {% if technician_cards_page %}
            <div class="mt-4">
              {% include "core/includes/pagination.html" with page_obj=technician_cards_page paginator=technician_cards_page.paginator query_string=technician_page_query page_param="jobs_page" show_single_page=True %}
            </div>
          {% endif %}
        </div>
      </section>
    {% endif %}

    {% if backoffice_cards %}
      <section class="space-y-4">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-semibold text-brand-foreground dark:text-white">{% trans "Awaiting approval" %}</h2>
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
            {% blocktrans count total=backoffice_cards|length %}{{ total }} request{% plural %}{{ total }} requests{% endblocktrans %}
          </span>
        </div>
        <div class="{{ section_shell }}">
          {% if backoffice_cards %}
            <div class="grid gap-3 md:grid-cols-2">
              {% for card in backoffice_cards %}
                <article class="{{ card_base }}">
                  <div class="flex items-start justify-between gap-3">
                    <div class="space-y-1">
                      <p class="text-[11px] font-semibold uppercase tracking-wide text-amber-700 dark:text-amber-200">{{ card.building }}</p>
                      <h3 class="text-base font-semibold text-slate-900 dark:text-white truncate">{{ card.title }}</h3>
                      {% if card.note %}
                        <p class="text-xs text-slate-600 dark:text-slate-300 line-clamp-2">{{ card.note }}</p>
                      {% endif %}
                    </div>
                    <span class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">
                      {{ card.awaiting_since }}
                    </span>
                  </div>
                  <div class="mt-2 flex flex-wrap gap-3 text-[12px] text-slate-600 dark:text-slate-300">
                    <span>{% trans "Requested by" %}: {{ card.requested_by|default:_('Unknown') }}</span>
                    <span>{% trans "Deadline" %}: {{ card.deadline }}</span>
                  </div>
                  <div class="mt-3 flex flex-wrap gap-2">
                    <a class="btn btn-xs" href="{% url 'core:work_order_detail' card.id %}">{% trans "Review" %}</a>
                    <a class="btn btn-secondary btn-xs" href="{% url 'core:work_order_update' card.id %}">{% trans "Update" %}</a>
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "No work orders are awaiting approval." %}</p>
          {% endif %}
        </div>
      </section>
    {% endif %}

    <section class="space-y-4">
      <div class="flex items-center justify-between gap-2">
        <h2 class="text-xl font-semibold text-brand-foreground dark:text-white">{% trans "Notifications" %}</h2>
        {% if notifications_page and notifications_page.paginator.count %}
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400 dark:text-slate-500">
            {% blocktrans count total=notifications_page.paginator.count %}{{ total }} notifications{% plural %}{{ total }} notifications{% endblocktrans %}
          </span>
        {% endif %}
      </div>
      <div class="{{ section_shell }}">
        {% if notifications_page and notifications_page.object_list %}
          <ul class="space-y-4">
            {% for note in notifications_page %}
              <li class="{{ card_base }} {{ note.card_classes|default:'' }}" style="{{ note.card_style|default:'' }}" data-notification-key="{{ note.id }}" data-is-new="{{ note.is_new|yesno:'true,false' }}">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                  <div class="flex-1 space-y-2">
                    {% if note.level %}
                      <span class="rounded-full px-3 py-1 text-[11px] font-semibold uppercase tracking-wide {{ note.badge_classes|default:'' }}" style="{{ note.badge_style|default:'' }}">{{ note.level_label|default:note.level }}</span>
                    {% endif %}
                    <p class="leading-snug">{{ note.message }}</p>
                  </div>
                  {% if note.dismissible %}
                    <form method="post"
                          action="{% url 'core:notification_snooze' note.id %}"
                          hx-post="{% url 'core:notification_snooze' note.id %}"
                          hx-target="closest li"
                          hx-swap="delete"
                          class="mt-2 inline-flex sm:mt-0">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-secondary btn-xs">{% trans "Read" %}</button>
                    </form>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
          {% if notifications_page %}
            <div class="mt-4">
              {% include "core/includes/pagination.html" with page_obj=notifications_page paginator=notifications_page.paginator query_string=note_page_query page_param="note_page" %}
            </div>
          {% endif %}
        {% else %}
          <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "No notifications right now." %}</p>
        {% endif %}
      </div>
    </section>
  {% endwith %}

  {% if not technician_cards and not backoffice_cards and not notifications %}
    <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "No dashboard data available for your role yet." %}</p>
  {% endif %}
</section>
{% endblock %}
