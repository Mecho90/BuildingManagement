{% extends "base.html" %}
{% load i18n form_helpers %}
{% block title %}
  {% if form.instance.pk %}{% trans "Edit user" %}{% else %}{% trans "Add user" %}{% endif %} Â· {% trans "Building Management" %}
{% endblock %}
{% block content %}
<section class="space-y-6">
  <header>
    <h1 class="text-3xl font-semibold text-brand-foreground dark:text-white">
      {% if form.instance.pk %}{% trans "Edit user" %}{% else %}{% trans "Add user" %}{% endif %}
    </h1>
    <p class="text-sm text-slate-500 dark:text-slate-400">
      {% if form.instance.pk %}
        {% trans "Update account details, flags, and contact information." %}
      {% else %}
        {% trans "Create a new account and assign the right access level." %}
      {% endif %}
    </p>
  </header>

  <form method="post" class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-card dark:border-slate-700 dark:bg-slate-900">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="alert alert--error">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <div class="grid gap-4 md:grid-cols-2 md:items-start">
      {% for field in form %}
        {% if field.field.widget.input_type == "checkbox" and field.name != "roles" %}
          <div class="md:col-span-2">
            <label class="flex items-start gap-3 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm font-medium text-slate-600 dark:border-slate-700 dark:bg-slate-800 dark:text-slate-200">
              {{ field }}
              <span>
                {{ field.label }}
                {% if field.help_text %}
                  <span class="block text-xs font-normal text-slate-500 dark:text-slate-400">{{ field.help_text }}</span>
                {% endif %}
              </span>
            </label>
            {% if field.errors %}
              <p class="mt-1 text-sm text-rose-600 dark:text-rose-400">{{ field.errors|striptags }}</p>
            {% endif %}
          </div>
        {% elif field.name == "roles" %}
          <div class="space-y-2 md:col-span-2">
            <span class="block text-sm font-medium text-slate-600 dark:text-slate-300">{{ field.label }}</span>
            <div class="grid gap-3 md:grid-cols-2">
              {% for choice in field %}
                <label class="flex gap-3 rounded-2xl border border-slate-200 bg-white/90 p-4 text-sm text-slate-700 shadow-sm transition hover:border-emerald-300 dark:border-slate-700 dark:bg-slate-900 dark:text-slate-200">
                  {{ choice.tag }}
                  <span>
                    <span class="font-semibold text-brand-foreground dark:text-white">{{ choice.choice_label }}</span>
                    <p class="text-xs text-slate-500 dark:text-slate-400">{{ form.role_descriptions|dict_get:choice.data.value }}</p>
                  </span>
                </label>
              {% endfor %}
            </div>
            {% if field.errors %}
              <p class="text-sm text-rose-600 dark:text-rose-400">{{ field.errors|striptags }}</p>
            {% endif %}
          </div>
        {% else %}
          <div class="space-y-2">
            <label for="{{ field.id_for_label }}" class="block text-sm font-medium text-slate-600 dark:text-slate-300">
              {{ field.label }}
            </label>
            {{ field }}
            {% if field.help_text %}
              <div class="text-xs text-slate-500 dark:text-slate-400 [&>ul]:list-disc [&>ul]:list-inside [&>ul]:space-y-1 [&>ul]:pl-4">
                {{ field.help_text|safe }}
              </div>
            {% elif field.name == "email" %}
              <p class="text-xs text-slate-500 dark:text-slate-400">{% trans "Optional, used for contact and password resets." %}</p>
            {% endif %}
            {% if field.errors %}
              <p class="text-sm text-rose-600 dark:text-rose-400">{{ field.errors|striptags }}</p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="flex flex-wrap justify-end gap-3">
      <button class="btn" type="submit">{% trans "Save" %}</button>
      <a class="btn btn-secondary" href="{% url 'core:users_list' %}">{% trans "Cancel" %}</a>
    </div>
  </form>
</section>
{% endblock %}
