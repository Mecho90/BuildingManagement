{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "User Management" %} · {% trans "Building Management" %}{% endblock %}
{% block content %}
<section class="space-y-8">
  <header class="rounded-2xl border border-slate-200 bg-white p-6 shadow-card dark:border-slate-700 dark:bg-slate-900 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="page-heading text-2xl font-semibold text-brand-foreground dark:text-white">{% trans "User Management" %}</h1>
      <p class="text-sm font-medium text-slate-600 dark:text-slate-300">
        {% blocktrans with count=users_total %}Total users: {{ count }}{% endblocktrans %}
      </p>
    </div>
    <div class="flex w-full flex-wrap justify-end gap-2 sm:w-auto">
      <a class="btn" href="{% url 'core:user_create' %}">{% trans "Add user" %}</a>
    </div>
  </header>

  <form method="get" class="filter-panel space-y-4">
    <div class="space-y-2">
      <label class="text-sm font-medium text-slate-600 dark:text-slate-300" for="id_search">{% trans "Search users" %}</label>
      <input
        id="id_search"
        class="input rounded-2xl border border-emerald-100/80 focus:border-emerald-400 focus:ring-emerald-200/70 dark:border-emerald-500/40"
        type="text"
        name="q"
        value="{{ q }}"
        placeholder="{% trans "Search username, email, or name" %}"
        autocomplete="off"
      />
    </div>
    <div class="space-y-2">
      <label class="text-sm font-medium text-slate-600 dark:text-slate-300" for="id_per">{% trans "Page size" %}</label>
      <select id="id_per" name="per" class="input rounded-2xl border border-emerald-100/80 focus:border-emerald-400 focus:ring-emerald-200/70 dark:border-emerald-500/40" onchange="this.form.submit()">
        <option value="25" {% if per == 25 %}selected{% endif %}>25</option>
        <option value="50" {% if per == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if per == 100 %}selected{% endif %}>100</option>
        <option value="200" {% if per == 200 %}selected{% endif %}>200</option>
      </select>
    </div>
    <div class="flex justify-end gap-2">
      <button class="btn" type="submit">{% trans "Search" %}</button>
      {% if q or per != 25 %}
        <a class="btn btn-secondary" href="{% url 'core:users_list' %}">{% trans "Clear" %}</a>
      {% endif %}
    </div>
  </form>

  <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-card dark:border-slate-700 dark:bg-slate-900">
    <table class="min-w-full divide-y divide-slate-200 rounded-2xl border border-slate-200 bg-white text-sm shadow-sm dark:divide-slate-800 dark:border-slate-800 dark:bg-slate-900">
        <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800 dark:text-slate-300">
          <tr>
            <th class="px-4 py-3">{% trans "Username" %}</th>
            <th class="px-4 py-3">{% trans "Name" %}</th>
            <th class="px-4 py-3">{% trans "Email" %}</th>
            <th class="px-4 py-3">{% trans "Active" %}</th>
            <th class="px-4 py-3">{% trans "Roles" %}</th>
            <th class="px-4 py-3">{% trans "Last login" %}</th>
            <th class="px-4 py-3 text-right">{% trans "Actions" %}</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
          {% for u in users %}
            <tr class="text-slate-700 dark:text-slate-100">
              <td class="px-4 py-3 font-medium">{{ u.username }}</td>
              <td class="px-4 py-3">{{ u.get_full_name|default:"—" }}</td>
              <td class="px-4 py-3">
                {% if u.email %}
                  <a href="mailto:{{ u.email }}" class="text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200">{{ u.email }}</a>
                {% else %}
                  —
                {% endif %}
              </td>
              {% trans "Yes,No" as yesno_choices %}
              <td class="px-4 py-3">{{ u.is_active|yesno:yesno_choices }}</td>
              <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400">
                {% if u.global_roles %}
                  {{ u.global_roles|join:", " }}
                {% else %}
                  —
                {% endif %}
              </td>
              <td class="px-4 py-3">{{ u.last_login|date:"Y-m-d H:i"|default:"—" }}</td>
              <td class="px-4 py-3 text-right">
                <div class="flex justify-end gap-2">
                  <a class="btn btn-secondary btn-sm" href="{% url 'core:user_update' u.pk %}">{% trans "Edit" %}</a>
                  <a class="btn btn-secondary btn-sm" href="{% url 'core:user_password' u.pk %}">{% trans "Reset password" %}</a>
                  <a class="btn btn-danger btn-sm" href="{% url 'core:user_delete' u.pk %}">{% trans "Delete" %}</a>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-4 py-6 text-center text-slate-500 dark:text-slate-400" colspan="9">
                {% trans "No users found." %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
    </table>
  </div>

  {% if is_paginated %}
    {% include "core/includes/pagination.html" with page_obj=page_obj paginator=paginator query_string=pagination_query %}
  {% endif %}

  {% if overview_rows %}
    <div class="overflow-x-auto rounded-3xl border border-slate-200 bg-white shadow-card dark:border-slate-700 dark:bg-slate-900 mt-6">
      <table class="min-w-full divide-y divide-slate-200 rounded-2xl border border-slate-200 bg-white text-sm shadow-sm dark:divide-slate-800 dark:border-slate-800 dark:bg-slate-900">
          <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800 dark:text-slate-300">
            <tr>
              <th class="px-4 py-3">{% trans "User" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Buildings" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Units" %}</th>
              <th class="px-4 py-3 text-right">{% trans "High priority tasks" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Medium priority tasks" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Low priority tasks" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Archived tasks" %}</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
            {% for row in overview_rows %}
              <tr class="text-slate-700 dark:text-slate-100">
                <td class="px-4 py-3 font-medium">{{ row.user.get_full_name|default:row.user.username }}</td>
                <td class="px-4 py-3 text-right">{{ row.buildings }}</td>
                <td class="px-4 py-3 text-right">{{ row.units }}</td>
                <td class="px-4 py-3 text-right">{{ row.priority_high }}</td>
                <td class="px-4 py-3 text-right">{{ row.priority_medium }}</td>
                <td class="px-4 py-3 text-right">{{ row.priority_low }}</td>
                <td class="px-4 py-3 text-right">{{ row.archived }}</td>
              </tr>
            {% endfor %}
          </tbody>
          {% if overview_totals %}
            <tfoot class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800/60 dark:text-slate-400">
              <tr>
                <th class="px-4 py-3 text-left">{% trans "Totals" %}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.buildings }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.units }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.priority_high }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.priority_medium }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.priority_low }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.archived }}</th>
              </tr>
            </tfoot>
          {% endif %}
      </table>
    </div>
  {% endif %}
</section>
{% endblock %}
