{% extends "base.html" %}
{% load i18n %}
{% block title %}{% trans "User Management" %} · {% trans "Building Management" %}{% endblock %}
{% block content %}
<section class="space-y-8">
  <header class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div>
      <h1 class="text-3xl font-semibold text-brand-foreground dark:text-white">{% trans "User Management" %}</h1>
      <p class="text-sm text-slate-500 dark:text-slate-400">
        {% trans "Administrators can create, edit, remove users or reset passwords from here." %}
      </p>
      <p class="text-sm font-medium text-slate-600 dark:text-slate-300">
        {% blocktrans with count=users_total %}Total users: {{ count }}{% endblocktrans %}
      </p>
    </div>
    <div class="flex w-full flex-wrap justify-end gap-2 sm:w-auto">
      <a class="btn" href="{% url 'core:user_create' %}">{% trans "Add user" %}</a>
    </div>
  </header>

  <form method="get" class="flex flex-col gap-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900 sm:flex-row sm:items-center">
    <label class="sr-only" for="id_search">{% trans "Search users" %}</label>
    <input
      id="id_search"
      class="input flex-1"
      type="text"
      name="q"
      value="{{ q }}"
      placeholder="{% trans "Search username, email, or name" %}"
    />
    <div class="flex items-center gap-2">
      <button class="btn" type="submit">{% trans "Search" %}</button>
      {% if q %}
        <a class="btn btn-secondary" href="{% url 'core:users_list' %}">{% trans "Clear" %}</a>
      {% endif %}
    </div>
  </form>

  <div class="space-y-3 rounded-2xl border border-slate-200 bg-white shadow-card dark:border-slate-700 dark:bg-slate-900">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 text-sm dark:divide-slate-800">
        <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800 dark:text-slate-300">
          <tr>
            <th class="px-4 py-3">{% trans "Username" %}</th>
            <th class="px-4 py-3">{% trans "Name" %}</th>
            <th class="px-4 py-3">{% trans "Email" %}</th>
            <th class="px-4 py-3">{% trans "Active" %}</th>
            <th class="px-4 py-3">{% trans "Administrator" %}</th>
            <th class="px-4 py-3">{% trans "Roles" %}</th>
            <th class="px-4 py-3">{% trans "Last login" %}</th>
            <th class="px-4 py-3 text-right">{% trans "Actions" %}</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
          {% for u in users %}
            <tr class="text-slate-700 dark:text-slate-100">
              <td class="px-4 py-3 font-medium">{{ u.username }}</td>
              <td class="px-4 py-3">{{ u.get_full_name|default:"—" }}</td>
              <td class="px-4 py-3">
                {% if u.email %}
                  <a href="mailto:{{ u.email }}" class="text-sky-600 hover:text-sky-700 dark:text-sky-300 dark:hover:text-sky-200">{{ u.email }}</a>
                {% else %}
                  —
                {% endif %}
              </td>
              {% trans "Yes,No" as yesno_choices %}
              <td class="px-4 py-3">{{ u.is_active|yesno:yesno_choices }}</td>
              <td class="px-4 py-3">{{ u.is_superuser|yesno:yesno_choices }}</td>
              <td class="px-4 py-3 text-xs text-slate-500 dark:text-slate-400">
                {% trans "Coming soon" %}
              </td>
              <td class="px-4 py-3">{{ u.last_login|date:"Y-m-d H:i"|default:"—" }}</td>
              <td class="px-4 py-3 text-right">
                <div class="flex justify-end gap-2">
                  <a class="btn btn-secondary btn-sm" href="{% url 'core:user_update' u.pk %}">{% trans "Edit" %}</a>
                  <a class="btn btn-secondary btn-sm" href="{% url 'core:user_password' u.pk %}">{% trans "Reset password" %}</a>
                  <a class="btn btn-danger btn-sm" href="{% url 'core:user_delete' u.pk %}">{% trans "Delete" %}</a>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td class="px-4 py-6 text-center text-slate-500 dark:text-slate-400" colspan="9">
                {% trans "No users found." %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

{% if is_paginated %}
  {% include "core/includes/pagination.html" with page_obj=page_obj paginator=paginator query_string=pagination_query %}
{% endif %}
</section>
  {% if overview_rows %}
    <section class="space-y-4 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-700 dark:bg-slate-900">
      <div class="flex flex-col gap-1">
        <h2 class="text-2xl font-semibold text-brand-foreground dark:text-white">{% trans "User overview" %}</h2>
        <p class="text-sm text-slate-500 dark:text-slate-400">{% trans "Summary of buildings, units, and tasks per user." %}</p>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 text-sm dark:divide-slate-800">
          <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800 dark:text-slate-300">
            <tr>
              <th class="px-4 py-3">{% trans "User" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Buildings" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Units" %}</th>
              <th class="px-4 py-3 text-right">{% trans "High priority tasks" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Medium priority tasks" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Low priority tasks" %}</th>
              <th class="px-4 py-3 text-right">{% trans "Archived tasks" %}</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200 dark:divide-slate-800">
            {% for row in overview_rows %}
              <tr class="text-slate-700 dark:text-slate-100">
                <td class="px-4 py-3 font-medium">{{ row.user.get_full_name|default:row.user.username }}</td>
                <td class="px-4 py-3 text-right">{{ row.buildings }}</td>
                <td class="px-4 py-3 text-right">{{ row.units }}</td>
                <td class="px-4 py-3 text-right">{{ row.priority_high }}</td>
                <td class="px-4 py-3 text-right">{{ row.priority_medium }}</td>
                <td class="px-4 py-3 text-right">{{ row.priority_low }}</td>
                <td class="px-4 py-3 text-right">{{ row.archived }}</td>
              </tr>
            {% endfor %}
          </tbody>
          {% if overview_totals %}
            <tfoot class="bg-slate-50 text-xs font-semibold uppercase tracking-wide text-slate-500 dark:bg-slate-800/60 dark:text-slate-400">
              <tr>
                <th class="px-4 py-3 text-left">{% trans "Totals" %}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.buildings }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.units }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.priority_high }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.priority_medium }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.priority_low }}</th>
                <th class="px-4 py-3 text-right">{{ overview_totals.archived }}</th>
              </tr>
            </tfoot>
          {% endif %}
        </table>
      </div>
    </section>
  {% endif %}
</section>
{% endblock %}
